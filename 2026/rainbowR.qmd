---
title: "Seeing what’s missing"
subtitle: "Visualization of incomplete and imputed data"
author: 
  - name: "Hanne Oberman"
    orcid: "0000-0003-3276-2141"
institute: "Utrecht University"
format:
  revealjs:
    logo: logo.png
    footer: "Hanne Oberman, hanneoberman.github.io/presentations"
    incremental: true
    toc: false
    toc-title: Overview
    embed-resources: true
css: ../../styles.css
---


<!-- In many data analysis efforts, missing data are conveniently ignored. But, if not treated well, missingness can lead to biased and invalid results. In this presentation, I will showcase the use and usefulness of a data visualization workflow for incomplete datasets in R -->

## Take aways

. . . 

Missing data are 

  - a pervasive problem
  - visualizable & analyzable
  - informative!


## Missingness

```{r setup, echo=FALSE}
library("mice")
library("ggmice")
library("ggplot2")
```

![](https://raw.githubusercontent.com/alan-turing-institute/turing-commons/main/docs/assets/images/illustrations/missing-data.png){width=30%}
<!-- https://raw.githubusercontent.com/alan-turing-institute/turing-commons/main/docs/assets/images/illustrations/missing-data.png -->

<!-- In many data analysis efforts, missing data are conveniently ignored. With default settings such as ‘listwise deletion’ in analysis software, analysts need not even bother with the ubiquitous problem of incomplete data. I argue that this is wasteful: not only can missing data bias analysis results if not addressed well, but moreover, missing data can provide valuable insights into the phenomena of interest. The visualization of incomplete data can uncover associations and intricacies between variables that may otherwise go overlooked. Which, in turn, can be leveraged in amending the missingness by means of imputation. The R package ggmice aids data analysts in exploring the missing parts of their data. In this presentation, I will showcase the use and usefulness of a data visualization workflow for incomplete datasets in R. -->

## A problem to fix

::: {.fragment}

- unit non-response 

:::

::: {.fragment}
  $\rightarrow$ weighting etc.
:::

::: {.fragment}

- item non-response 

:::

::: {.fragment}
  $\rightarrow$ imputation etc.
:::

<!-- - unit non-response  -->
<!--   $\rightarrow$ weighting etc. -->
<!-- - item non-response  -->
<!--   $\rightarrow$ imputation etc. -->

::: {.notes}
test
:::

## Biasing results

<!-- $\rightarrow$  -->

- under-representation
- sensitive questions
- 'missed' missing values


## Missing values...

- ...are those values that are not observed
- ...do exist in theory, but we are unable to see them

<!-- <br> -->
<!-- <br> -->

. . . 

```{r}
dat <- data.frame(x = 1:5, y = c(0.1, 0.6, 0.8, NA, 0.3))
ggmice(dat, aes(x, y)) + #, shape = is.na(y)
  geom_point(size = 3) +
  # scale_shape_manual(limits = T:F, values = 1:2) +
  labs(x = "", y = "")
```

## Imputation

```{r}
dat[is.na(dat)] <- 0.5
ggmice(dat, aes(x,y)) +
  geom_point(size = 3) +
  labs(x = "", y = "")
```

## Example data

```{r, echo=FALSE}
library(ggplot2)
dat_raw <- read.csv("~/Downloads/table_2CE4F5AC7A7A48E9A5AFC8D7E2DF7C9C.csv", header=FALSE)
nms <- as.character(dat_raw[1, -1])
dat_pre <- dat_raw[-1, -1] |> setNames(nms)
dat_pre[dat_pre == ""] <- NA
dat_wide <- dat_pre |> 
  na.omit() |>
  t() |>
  as.data.frame()

row.names(dat_wide)[-1] 
age_cats <- c("15-24", "25-44", "45-64", "65+")
names(age_cats) <- age_cats
queer_cats <- c(rep(1, length(age_cats)), rep(0, length(age_cats))) 

dat <- data.frame(age = rep(age_cats, 2), LGBTQIA = factor(queer_cats, levels = 0:1, labels = c("no", "yes")), prop = c(dat_wide[-1, 1], dat_wide[-1, 2]))  

ggplot(dat, aes(age, prop, color = LGBTQIA)) +
  geom_point() +
  ggmice:::theme_mice()

```


## Case study

```{r, echo=TRUE, warning=FALSE, message=FALSE}
#| code-line-numbers: "2"
set.seed(123)
library(ricu)
library(mice)
library(ggmice)
library(ggplot2)
source("../2025/ISI/mimic.r")
dat <- mimic_demo |> clean_mimic_demo()
```

![](https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fsdata.2016.35/MediaObjects/41597_2016_Article_BFsdata201635_Fig1_HTML.jpg){fig-align="center" width=60%}

## Incomplete data

```{r, echo=TRUE}
str(dat)
```

## Incomplete data

```{r, echo=TRUE}
visdat::vis_dat(dat)
```

## Response indicator

```{r, echo=TRUE}
is.na(dat)
```

## Response indicator

```{r, echo=TRUE}
naniar::vis_miss(dat)
```

## Missingness rate

```{r, echo=TRUE}
colSums(is.na(dat))
```

## Missingness rate

```{r, echo=TRUE}
VIM::aggr(dat, numbers = TRUE, prop = FALSE)
```

## Missing data pattern

```{r, echo=TRUE}
mice::md.pattern(dat)
```

## Missing data pattern

```{r, echo=TRUE}
ggmice::plot_pattern(dat, square = FALSE)
```

## Coma symptoms

```{r, echo=TRUE}
#| code-fold: true
ggmice(dat, aes(x = tgcs)) +
  geom_bar(fill = "white") 
```


## Coma symptoms by mortality

```{r, echo=TRUE}
#| code-fold: true
ggmice(dat, aes(x = tgcs)) +
  geom_bar(fill = "white")  +
  facet_wrap(~factor(
    mortality, 
    levels = c(TRUE, FALSE), 
    labels = c("patient deceased", "patient alive")
    ), ncol = 1)
```


<!-- ## Blood pressure  -->

<!-- ```{r, echo=TRUE} -->
<!-- #| code-fold: true -->

<!-- ggmice(dat, aes(x = map)) + -->
<!--   geom_histogram() +  -->
<!--   facet_wrap(~factor( -->
<!--     mortality,  -->
<!--     levels = c(TRUE, FALSE),  -->
<!--     labels = c("patient deceased", "patient alive") -->
<!--     ), ncol = 1) -->
<!-- ``` -->

<!-- ## Populations by sex -->

<!-- ```{r, echo=TRUE} -->
<!-- #| code-fold: true -->
<!-- ggplot(penguins, aes(x = year, fill = sex, group = sex)) + -->
<!--   geom_bar(position = "dodge") +  -->
<!--   scale_x_continuous(breaks = c(2007, 2008, 2009)) + -->
<!--   theme_classic() -->
<!-- ``` -->

<!-- ## Populations by sex and species -->

<!-- ```{r, echo=TRUE} -->
<!-- #| code-fold: true -->
<!-- ggplot(penguins, aes(x = year, fill = sex, group = sex)) + -->
<!--   geom_bar(position = "dodge") +  -->
<!--   facet_wrap(~species) +  -->
<!--   scale_x_continuous(breaks = c(2007, 2008, 2009)) + -->
<!--   theme_classic() -->
<!-- ``` -->

## Blood pressure by mortality

```{r, echo=TRUE}
#| code-fold: true
ggmice(dat, aes(x = map, y = mortality)) +
  geom_point()
```

<!-- ## Oxygenation  -->
<!-- ```{r, echo=TRUE} -->
<!-- #| code-fold: true -->

<!-- ggmice(dat, aes(x = pao2)) + -->
<!--   geom_density() +  -->
<!--   facet_wrap(~factor( -->
<!--     mortality,  -->
<!--     levels = c(TRUE, FALSE),  -->
<!--     labels = c("patient deceased", "patient alive") -->
<!--     ), ncol = 1) -->
<!-- ``` -->


## Blood oxygenation by mortality

```{r, echo=TRUE}
#| code-fold: true
ggmice(dat, aes(x = pao2, y = mortality)) +
  geom_jitter(width = 0, height = 0.1)
```

## Scatter plot

```{r, echo=TRUE}
#| code-fold: true
ggmice(dat, aes(x = pao2, y = map)) +
  geom_jitter(height = 0)
```

## Faceted scatter plot

```{r, echo=TRUE}
#| code-fold: true
ggmice(dat, aes(x = pao2, y = map)) +
  geom_jitter(height = 0) +
    facet_wrap(~factor(
    mortality, 
    levels = c(TRUE, FALSE), 
    labels = c("patient deceased", "patient alive")
    ), ncol = 1)
```

## Imputation workflow

![](https://stefvanbuuren.name/fimd/fig/ch01-miflow-1.png){fig-align="center"}

## Imputation models

```{r, echo=TRUE}
pred <- make.predictorMatrix(dat)
meth <- make.method(dat)
plot_pred(pred, method = meth, square = FALSE)
```

## Correlation 

```{r, echo=TRUE}
plot_corr(dat, square = FALSE, label = TRUE)
```

## Imputation models

```{r, echo=TRUE}
pred <- quickpred(dat, mincor = 0.3)
plot_pred(pred, method = meth, square = FALSE)
```


## Scatter plot

```{r, echo=TRUE}
ggmice(dat, aes(pao2, map)) +
  geom_point(size = 2)
```

## Faceted distribution

```{r, echo=TRUE}
ggmice(dat, aes(map)) +
  geom_histogram(fill = "white") +
  facet_grid(factor(
    is.na(pao2), 
    levels = c(TRUE, FALSE), 
    labels = c("missing PaO2", "observed PaO2")
    ) ~ .)
```

## Faceted scatter plot

```{r, echo=TRUE}
ggmice(dat, aes(pao2, map)) +
  geom_point(size = 2) +
  facet_wrap(~factor(
    mortality, 
    levels = c(TRUE, FALSE), 
    labels = c("patient deceased", "patient alive")
    ), ncol = 1)
```

<!-- ## Faceted distribution -->

<!-- ```{r, echo=TRUE} -->
<!-- ggmice(dat, aes(fio2)) + -->
<!--   geom_histogram(fill = "white") + -->
<!--   facet_grid(factor( -->
<!--     is.na(pao2),  -->
<!--     levels = c(TRUE, FALSE),  -->
<!--     labels = c("missing sex", "observed sex") -->
<!--     ) ~ mortality) -->
<!-- ``` -->

## Adjust imputation models

```{r, echo=TRUE}
pred["map", c("pao2", "mortality")] <- 1
plot_pred(pred, method = meth, square = FALSE)
```

## Impute

```{r, echo=TRUE, fig.width=15}
imp <- mice(
  dat, 
  pred = pred, 
  method = meth,
  m = 3,
  seed = 11,
  print = FALSE)
plot_trace(imp, legend = FALSE)
```

## Stripplot of blood pressure

```{r, echo=TRUE}
ggmice(imp, aes(x = .imp, y = map)) +
  geom_jitter(width = 0.05) +
  labs(x = "Imputation number")
```

## Stripplot of oxygenation

```{r, echo=TRUE}
ggmice(imp, aes(x = .imp, y = pao2)) +
  geom_jitter(width = 0.05) +
  labs(x = "Imputation number")
```

## Blood pressure by mortality

```{r}
ggmice(dat, aes(x = map, y = mortality)) +
  geom_jitter(width = 0, height = 0.1)
```

## Blood pressure by mortality

```{r}
ggmice(imp, aes(x = map, y = mortality)) +
  geom_jitter(width = 0, height = 0.1)
```

## Oxygenation by mortality

```{r}
ggmice(dat, aes(x = pao2, y = mortality)) +
  geom_jitter(width = 0, height = 0.1) 
```

## Oxygenation by mortality

```{r}
ggmice(imp, aes(x = pao2, y = mortality)) +
  geom_jitter(width = 10, height = 0.1)
```

## Scatter plot

```{r}
ggmice(dat, aes(x = pao2, y = map)) +
  geom_jitter(height = 0)
```

## Scatter plot

```{r}
ggmice(imp, aes(x = pao2, y = map)) +
  geom_jitter(height = 0)
```

## Faceted scatter plot

```{r, echo=TRUE}
ggmice(dat, aes(pao2, map)) +
  geom_point(size = 2) +
  facet_wrap(~factor(
    mortality, 
    levels = c(TRUE, FALSE), 
    labels = c("patient deceased", "patient alive")
    ), ncol = 1)
```

## Faceted scatter plot

```{r, echo=TRUE}
ggmice(imp, aes(pao2, map)) +
  geom_point(size = 2) +
  facet_wrap(~factor(
    mortality, 
    levels = c(TRUE, FALSE), 
    labels = c("patient deceased", "patient alive")
    ), ncol = 1)
```



<!-- ## Boxplot after imputation -->

<!-- ```{r, echo=TRUE} -->
<!-- ggmice(imp, aes(pao2, fio2)) + -->
<!--   geom_boxplot() + -->
<!--   facet_grid(~mortality) -->
<!-- ``` -->




<!-- ## Faceted distribution -->

<!-- ```{r, echo=TRUE} -->
<!-- ggmice(imp, aes(pao2, group = factor(.imp, levels = 20:0, ordered = TRUE))) + -->
<!--   geom_histogram(fill = "white", stat = "count") + -->
<!--   facet_grid(~ mortality) -->
<!-- ``` -->

## Faceted distribution

```{r, echo=TRUE}
ggmice(imp, aes(pao2, group = .imp, linetype = !(.imp == 0))) +
  geom_density() +
  facet_wrap(~factor(
    mortality, 
    levels = c(TRUE, FALSE), 
    labels = c("patient deceased", "patient alive")
    ), ncol = 1) +
  scale_linetype(guide = "none")
```

<!-- ## Populations before imputation -->

<!-- ```{r, echo=TRUE} -->
<!-- #| code-fold: true -->
<!-- ggplot(dat, aes(x = year, fill = sex, group = sex)) + -->
<!--   geom_bar(position = "dodge") +  -->
<!--   facet_wrap(~species) +  -->
<!--   scale_x_continuous(breaks = c(2007, 2008, 2009)) + -->
<!--   theme_classic() -->
<!-- ``` -->

<!-- ## Populations after imputation -->

<!-- ```{r, echo=TRUE} -->
<!-- #| code-fold: true -->
<!-- ggplot(complete(imp), aes(x = year, fill = sex, group = sex)) + -->
<!--   geom_bar(position = "dodge") + -->
<!--   facet_wrap( ~ species) + -->
<!--   scale_x_continuous(breaks = c(2007, 2008, 2009)) + -->
<!--   theme_classic() -->
<!-- ``` -->

## Take aways

Missing data are 

  - a pervasive problem
  - visualizable & analyzable
  - informative!

## Thank you!

![](https://edu.nl/nbd3q~?format=svg)

---

## Missingness

<center>
![](https://raw.githubusercontent.com/alan-turing-institute/turing-commons/main/docs/assets/images/illustrations/missing-data.png){width=30%}
<center/>

:::{.notes}
- missing data are a problem to solve
- we would have perfect results if it was not for those pesky missing values
:::

:::{.footer}
The Turing Way (DOI: 10.5281/zenodo.3332807)
:::


## A problem to fix

:::: {.columns}

::: {.column width="50%"}

::: {.fragment}

- unit non-response 

:::

::: {.fragment}
  $\rightarrow$ weighting etc.
:::

::: {.fragment}

- item non-response 

:::

::: {.fragment}
  $\rightarrow$ deletion etc.
:::

:::


::: {.column width="30%"}


::: {.fragment}

::: {.callout-tip icon=false title=""}

## <br>

What is your gender?

- [ ] male
- [ ] female

:::

:::

:::

::::

<!-- - unit non-response $\rightarrow$ weighting  -->
<!-- - item non-response $\rightarrow$ deletion or imputation -->
<!-- - 'missed' missing values $\rightarrow$ ignored -->

:::{.notes}
- unit non-resp: hard to reach populations, low trust --> under-representation
- item non-resp: skipped sensitive questions, drop-out --> over-estimation of effects
- missing data are a nuisance, but they can be informative too
- it may tell us there's a mismatch between our data collection and 'real world' (e.g. lived experience of respondents)
:::

## Take aways

Missing data are 

  - a pervasive problem
  - visualizable & analyzable
  - informative!

<!-- ## Missing values... -->

<!-- - ...are those values that are not observed -->
<!-- - ...do exist in theory, but we are unable to see them -->


## Missing data in `R`

```{r}
#| echo: false
dat <- data.frame(x = 1:5, y = c(0.1, 0.6, 0.8, NA, 0.3))
ggmice::ggmice(dat, ggplot2::aes(x, y)) + #, shape = is.na(y)
  ggplot2::geom_point(size = 3) +
  # scale_shape_manual(limits = T:F, values = 1:2) +
  ggplot2::labs(x = "", y = "")
```

## Case study

```{r}
#| code-line-numbers: "11|12"
# set-up
library(ggplot2)
library(mice)
library(ggmice)
library(dplyr)
set.seed(123)

# data-generation
n <- 20
dat <- tibble(
  r_use = sample(1:5, size = n, replace = TRUE),
  happy = 0.5 * r_use + rnorm(n, mean = 6)
)
```


<!-- attr(dat$r_use, "label") <- "R use (days/week)" -->
<!-- attr(dat$happy, "label") <- "Happiness" -->

## Complete data

```{r}
ggmice(dat, aes(r_use, happy)) + 
  geom_point()
```

## Incomplete data

```{r}
#| code-line-numbers: "1"
dat <- rbind(dat, c(r_use = 7, happy = NA))
ggmice(dat, aes(r_use, happy)) + 
  geom_point()
```


::: {.notes}
- risk biasing results by ignoring
- retrieve failed
- imputing
:::

## Plausible values

```{r}
ggmice(dat, aes(r_use, happy)) + 
  geom_point() +
  geom_smooth(method = "lm", fullrange = TRUE)
```


::: {.notes}
- replacing missing values with plausible 
- use observed part of the data to 'guestimate'
:::

## Mean imputation

```{r}
#| code-line-numbers: "1"
imp <- mice(dat, meth = "mean", print = FALSE)
ggmice(imp, aes(r_use, happy)) + 
  geom_point() +
  geom_smooth(method = "lm", fullrange = TRUE)
```


## Regression imputation

```{r}
#| code-line-numbers: "1"
imp <- mice(dat, meth = "norm.predict", print = FALSE)
ggmice(imp, aes(r_use, happy)) + 
  geom_point() +
  geom_smooth(method = "lm", fullrange = TRUE)
```


## Multiple imputation

```{r}
#| code-line-numbers: "1"
imp <- mice(dat, meth = "norm", print = FALSE)
ggmice(imp, aes(r_use, happy)) + 
  geom_point() +
  geom_smooth(method = "lm", fullrange = TRUE)
```


## Multiple imputation workflow

<center>![](flow.png){height="600"}</center>

## Imputation models




## Take aways

Missing data are 

  - a pervasive problem
  - visualizable & analyzable
  - informative!

## Thank you!

![](https://edu.nl/nbd3q~?format=svg)


